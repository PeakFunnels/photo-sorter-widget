async function e(){return new Promise(((e,t)=>{const a=indexedDB.open("file-sorter-db",1);a.onupgradeneeded=()=>{a.result.createObjectStore("handles")},a.onsuccess=()=>e(a.result),a.onerror=()=>t(a.error)}))}async function t(t){const a=(await e()).transaction("handles","readwrite");return a.objectStore("handles").put(t,"last"),new Promise((e=>{a.oncomplete=e}))}async function a(e,t=[]){for await(let[n,i]of e)if("file"===i.kind){const e=await i.getFile();t.push({name:n,handle:i,date:e.lastModified})}else"directory"===i.kind&&await a(i,t);return t}const n=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".tiff"],i=[".mp4",".mov",".webm"];let o,r=0,c=[];function d(e,t,a,o,d){e.innerHTML="",r=0,c=function(e,t,a,o){let r=[...e];const c=t.trim().toLowerCase();return c&&(r=r.filter((e=>e.name.toLowerCase().includes(c)))),"all"!==a&&(r=r.filter((e=>{const t=e.name.slice(e.name.lastIndexOf(".")).toLowerCase();return"photos"===a?n.includes(t):i.includes(t)}))),"alpha"===o?r.sort(((e,t)=>e.name.localeCompare(t.name))):r.sort(((e,t)=>t.date-e.date)),r}(t,a,o,d),s(e)}async function s(e){const t=c.slice(r,r+30);for(let a of t){const t=document.createElement("div");t.className="thumb",t._handle=a.handle,t._filename=a.name;const n=document.createElement("div");n.className="icon",n.textContent="â€¦",t.appendChild(n);const i=document.createElement("div");i.className="name",i.textContent=a.name,t.appendChild(i),e.appendChild(t),o.observe(t)}r+=t.length}const l=document.getElementById("pickBtn"),m=document.getElementById("refreshBtn"),u=document.getElementById("searchInput"),g=document.getElementById("mediaFilter"),h=document.getElementById("sortSelect"),p=document.getElementById("includeSub"),w=document.getElementById("thumbGrid"),y=document.getElementById("tree"),f=document.getElementById("addCat"),v=document.querySelector('.nav-item[data-type="root"]'),E=document.getElementById("breadcrumb"),L=document.getElementById("metaModal"),C=L.querySelector(".close");let b,I,k=[];var D;function B(e){document.querySelectorAll(".nav-item, .group").forEach((e=>e.classList.remove("active"))),e.classList.add("active")}function H(e,t){E.textContent=e?t?`Home / ${e} / ${t}`:`Home / ${e}`:"Home"}async function M(){k=p.checked?await a(I):await async function(e){const t=[];for await(let[a,n]of e)if("file"===n.kind){const e=await n.getFile();t.push({name:a,handle:n,date:e.lastModified})}return t}(I),d(w,k,u.value,g.value,h.value),H(),m.disabled=!1}async function S(){const e=await async function(e){const t=[];for await(let[a,n]of e)if("directory"===n.kind){const e=[];for await(let[t,a]of n)"directory"===a.kind&&e.push(t);t.push({name:a,handle:n,groups:e})}return t}(b);var t,a,n,i;a=e,n=async(e,t,a)=>{B(a),I=await e.getDirectoryHandle(t),H(e.name,t),await M()},i=async(e,t,a)=>{if("reload"===e)return void await S();const n=JSON.parse(e.dataTransfer.getData("application/json"));let i=0,o=0;for(let e of n)try{const n=k.find((t=>t.name===e)),o=await n.handle.getFile(),r=await t.getDirectoryHandle(a,{create:!0}),c=await r.getFileHandle(e,{create:!0}),d=await c.createWritable();await d.write(o),await d.close(),await I.removeEntry(e),i++}catch{o++}alert(`Moved ${i} file${1!==i?"s":""}${o?`, ${o} failed`:""}.`),await M()},(t=y).innerHTML="",a.forEach((e=>{const a=document.createElement("div");a.className="category";const o=document.createElement("div");o.className="cat-header",o.textContent=e.name;const r=document.createElement("button");r.textContent="âž•",r.addEventListener("click",(async()=>{const t=prompt("New Group:");t&&(await e.handle.getDirectoryHandle(t,{create:!0}),i("reload"))})),o.appendChild(r),a.appendChild(o),e.groups.forEach((t=>{const o=document.createElement("div");o.className="group",o.textContent=t,o.addEventListener("click",(()=>{n(e.handle,t)})),o.addEventListener("dragover",(e=>{e.preventDefault(),o.classList.add("dragover")})),o.addEventListener("dragleave",(()=>{o.classList.remove("dragover")})),o.addEventListener("drop",(a=>{a.preventDefault(),o.classList.remove("dragover"),i(a,e.handle,t)})),a.appendChild(o)})),t.appendChild(a)}))}D=async function(e,t){const a=await e.getFile(),n=parseInt(getComputedStyle(t).getPropertyValue("--thumb")),i=URL.createObjectURL(a),o=document.createElement("video"),r=""!==o.canPlayType(a.type);if(a.type.startsWith("video/")&&r)o.preload="metadata",o.muted=!0,o.src=i,o.currentTime=.5,o.onseeked=async()=>{const e=await createImageBitmap(o,{resizeWidth:n,resizeHeight:n,resizeQuality:"high"}),a=document.createElement("canvas");a.width=a.height=n,a.getContext("2d").drawImage(e,0,0);const i=document.createElement("img");i.src=a.toDataURL("image/jpeg",.75),t.replaceChild(i,t.querySelector(".icon"))};else if(a.type.startsWith("image/")){const e=new Image;e.src=i,e.onload=async()=>{const a=await createImageBitmap(e,{resizeWidth:n,resizeHeight:n,resizeQuality:"high"}),i=document.createElement("canvas");i.width=i.height=n,i.getContext("2d").drawImage(a,0,0);const o=document.createElement("img");o.src=i.toDataURL("image/jpeg",.75),t.replaceChild(o,t.querySelector(".icon"))}}else if(a.type.startsWith("video/")){const e=document.createElement("div");e.className="icon",e.textContent="ðŸŽ¥",t.replaceChild(e,t.querySelector(".icon"))}else{const e=document.createElement("div");e.className="icon",e.textContent="ðŸ“„",t.replaceChild(e,t.querySelector(".icon"))}},o=new IntersectionObserver((e=>{for(let t of e)t.isIntersecting&&!t.target._loaded&&(D(t.target._handle,t.target),t.target._loaded=!0,o.unobserve(t.target))}),{root:w,rootMargin:"200px"}),w.addEventListener("scroll",(()=>{w.scrollTop+w.clientHeight>=w.scrollHeight-100&&s(w)})),l.addEventListener("click",(async()=>{b=await window.showDirectoryPicker(),await t(b),I=b,await M(),await S(),B(v)})),f.addEventListener("click",(async()=>{const e=prompt("New Album:");e&&(await b.getDirectoryHandle(e,{create:!0}),await S())})),m.addEventListener("click",M),u.addEventListener("input",M),g.addEventListener("change",M),h.addEventListener("change",M),p.addEventListener("change",(()=>{M()})),w.addEventListener("click",(e=>{if(e.target.matches('.thumb .actions button[title="Metadata"]')){const t=e.target.closest(".thumb");!async function(e,t){const{name:a,handle:n}=e,i=await n.getFile();let o={};i.type.startsWith("image/")&&window.EXIF&&await new Promise((e=>{EXIF.getData(i,(function(){o=EXIF.getAllTags(this),e()}))}));const r={};if(r["File Name"]=a,o.DateTimeOriginal&&(r["Original Date"]=o.DateTimeOriginal),(o.Make||o.Model)&&(r.Camera=[o.Make,o.Model].filter(Boolean).join(" ")),i.type.startsWith("video/")){const e=URL.createObjectURL(i),t=document.createElement("video");t.preload="metadata",t.src=e,await new Promise((e=>{t.onloadedmetadata=()=>{r.Duration=`${t.duration.toFixed(2)} s`,r.Width=t.videoWidth,r.Height=t.videoHeight,e()}}))}r.Size=`${i.size} bytes`,r.Type=i.type,r["Last Modified"]=new Date(i.lastModified).toLocaleString(),renderMetaModal(r,t)}(k.find((e=>e.name===t._filename)),L)}})),C.addEventListener("click",(()=>{L.style.display="none"})),window.addEventListener("load",(async()=>{const a=await async function(){const t=(await e()).transaction("handles","readonly");return new Promise((e=>{const a=t.objectStore("handles").get("last");a.onsuccess=()=>e(a.result),a.onerror=()=>e(null)}))}();a?b=a:(b=await window.showDirectoryPicker({startIn:"downloads"}),await t(b)),I=b,await M(),await S(),B(v)}));
//# sourceMappingURL=widget.js.map
