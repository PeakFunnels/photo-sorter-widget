async function e(){return new Promise(((e,t)=>{const a=indexedDB.open("file-sorter-db",1);a.onupgradeneeded=()=>{a.result.createObjectStore("handles")},a.onsuccess=()=>e(a.result),a.onerror=()=>t(a.error)}))}async function t(t){const a=(await e()).transaction("handles","readwrite");return a.objectStore("handles").put(t,"last"),new Promise((e=>{a.oncomplete=e}))}async function a(e,t=[]){for await(let[n,o]of e)if("file"===o.kind){const e=await o.getFile();t.push({name:n,handle:o,date:e.lastModified})}else"directory"===o.kind&&await a(o,t);return t}const n=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".tiff"],o=[".mp4",".mov",".webm"];let i,c=0,r=[];function l(e,t,a,i,l){e.innerHTML="",c=0,r=function(e,t,a,i){let c=[...e];const r=t.trim().toLowerCase();return r&&(c=c.filter((e=>e.name.toLowerCase().includes(r)))),"all"!==a&&(c=c.filter((e=>{const t=e.name.slice(e.name.lastIndexOf(".")).toLowerCase();return"photos"===a?n.includes(t):o.includes(t)}))),"alpha"===i?c.sort(((e,t)=>e.name.localeCompare(t.name))):c.sort(((e,t)=>t.date-e.date)),c}(t,a,i,l),s(e)}async function s(e){const t=r.slice(c,c+30);for(let a of t){const t=document.createElement("div");t.className="thumb",t._handle=a.handle,t._filename=a.name;const n=document.createElement("div");n.className="icon",n.textContent="…",t.appendChild(n);const c=document.createElement("div");c.className="actions";const r=a.name.slice(a.name.lastIndexOf(".")).toLowerCase(),l=document.createElement("button");l.textContent="✎",l.title="Rename",l.onclick=async e=>{e.stopPropagation();const t=prompt("Rename to:",a.name.replace(r,""));if(!t)return;const n=t.endsWith(r)?t:t+r,o=await a.handle.getFile(),i=await currentHandle.getFileHandle(n,{create:!0}),c=await i.createWritable();await c.write(o),await c.close(),await currentHandle.removeEntry(a.name),await loadRootFiles()},c.appendChild(l);const s=document.createElement("button");s.textContent="🗑",s.title="Delete",s.onclick=async e=>{e.stopPropagation(),confirm(`Delete ${a.name}?`)&&(await currentHandle.removeEntry(a.name),await loadRootFiles())},c.appendChild(s);const d=document.createElement("button");d.textContent="ℹ️",d.title="Metadata",c.appendChild(d);const m=document.createElement("button");m.textContent=o.includes(r)?"▶️":"🔍",m.title="Open",m.onclick=async e=>{e.stopPropagation();const t=await a.handle.getFile(),n=URL.createObjectURL(t);window.open(n,"_blank")},c.appendChild(m),t.appendChild(c);const u=document.createElement("div");u.className="name",u.textContent=a.name,t.appendChild(u),t.onclick=n=>{n.preventDefault(),n.ctrlKey||n.metaKey?selected.has(a)?(selected.delete(a),t.classList.remove("selected")):(selected.add(a),t.classList.add("selected")):(e.querySelectorAll(".thumb.selected").forEach((e=>e.classList.remove("selected"))),selected.clear(),selected.add(a),t.classList.add("selected"))},t.draggable=!0,t.ondragstart=e=>{const t=selected.has(a)?Array.from(selected).map((e=>e.name)):[a.name],n=JSON.stringify(t);e.dataTransfer.setData("text/plain",n)},e.appendChild(t),i.observe(t)}c+=t.length}const d=document.getElementById("pickBtn"),m=document.getElementById("refreshBtn"),u=document.getElementById("searchInput"),p=document.getElementById("mediaFilter"),g=document.getElementById("sortSelect"),h=document.getElementById("includeSub"),w=document.getElementById("thumbGrid"),y=document.getElementById("tree"),f=document.getElementById("addCat"),v=document.querySelector('.nav-item[data-type="root"]'),E=document.getElementById("breadcrumb"),C=document.getElementById("metaModal"),b=C.querySelector(".close");let L,I,k=[];var D;function x(e){document.querySelectorAll(".nav-item, .group").forEach((e=>e.classList.remove("active"))),e.classList.add("active")}function H(e,t){E.textContent=e?t?`Home / ${e} / ${t}`:`Home / ${e}`:"Home"}async function S(){k=h.checked?await a(I):await async function(e){const t=[];for await(let[a,n]of e)if("file"===n.kind){const e=await n.getFile();t.push({name:a,handle:n,date:e.lastModified})}return t}(I),l(w,k,u.value,p.value,g.value),H(),m.disabled=!1}async function B(){const e=await async function(e){const t=[];for await(let[a,n]of e)if("directory"===n.kind){const e=[];for await(let[t,a]of n)"directory"===a.kind&&e.push(t);t.push({name:a,handle:n,groups:e})}return t}(L);!function(e,t,a,n){e.innerHTML="",t.forEach((t=>{const o=document.createElement("div");o.className="category";const i=document.createElement("div");i.className="cat-header",i.textContent=t.name;const c=document.createElement("button");c.textContent="➕",c.onclick=async()=>{const e=prompt("New Group:");e&&(await t.handle.getDirectoryHandle(e,{create:!0}),n("reload"))},i.appendChild(c),o.appendChild(i),t.groups.forEach((e=>{const i=document.createElement("div");i.className="group",i.textContent=e,i.onclick=()=>a(t.handle,e,i),i.addEventListener("dragover",(e=>{e.preventDefault(),i.classList.add("dragover")})),i.addEventListener("dragleave",(()=>i.classList.remove("dragover"))),i.addEventListener("drop",(a=>{a.preventDefault(),i.classList.remove("dragover"),n(a,t.handle,e)})),o.appendChild(i)})),e.appendChild(o)}))}(y,e,(async(e,t,a)=>{x(a),I=await e.getDirectoryHandle(t),H(e.name,t),await S()}),(async(e,t,a)=>{if("reload"===e)return await B();const n=e.dataTransfer.getData("text/plain");if(!n)return;const o=JSON.parse(n);let i=0,c=0;for(const e of o)try{const n=k.find((t=>t.name===e)),o=await n.handle.getFile(),c=await t.getDirectoryHandle(a,{create:!0}),r=await c.getFileHandle(e,{create:!0}),l=await r.createWritable();await l.write(o),await l.close(),await I.removeEntry(e),i++}catch{c++}alert(`Moved ${i} file${1!==i?"s":""}${c?`, ${c} failed`:""}.`),await S()}))}D=async function(e,t){const a=await e.getFile(),n=parseInt(getComputedStyle(t).getPropertyValue("--thumb")),o=URL.createObjectURL(a),i=document.createElement("video"),c=""!==i.canPlayType(a.type);if(a.type.startsWith("video/")&&c)i.preload="metadata",i.muted=!0,i.src=o,i.currentTime=.5,i.onseeked=async()=>{const e=await createImageBitmap(i,{resizeWidth:n,resizeHeight:n,resizeQuality:"high"}),a=document.createElement("canvas");a.width=a.height=n,a.getContext("2d").drawImage(e,0,0);const o=document.createElement("img");o.src=a.toDataURL("image/jpeg",.75),t.replaceChild(o,t.querySelector(".icon"))};else if(a.type.startsWith("image/")){const e=new Image;e.src=o,e.onload=async()=>{const a=await createImageBitmap(e,{resizeWidth:n,resizeHeight:n,resizeQuality:"high"}),o=document.createElement("canvas");o.width=o.height=n,o.getContext("2d").drawImage(a,0,0);const i=document.createElement("img");i.src=o.toDataURL("image/jpeg",.75),t.replaceChild(i,t.querySelector(".icon"))}}else if(a.type.startsWith("video/")){const e=document.createElement("div");e.className="icon",e.textContent="🎥",t.replaceChild(e,t.querySelector(".icon"))}else{const e=document.createElement("div");e.className="icon",e.textContent="📄",t.replaceChild(e,t.querySelector(".icon"))}},i=new IntersectionObserver((e=>{for(let t of e)t.isIntersecting&&!t.target._loaded&&(D(t.target._handle,t.target),t.target._loaded=!0,i.unobserve(t.target))}),{root:w,rootMargin:"200px"}),w.addEventListener("scroll",(()=>{w.scrollTop+w.clientHeight>=w.scrollHeight-100&&s(w)})),d.onclick=async()=>{L=await window.showDirectoryPicker(),await t(L),I=L,await S(),await B(),x(v)},f.onclick=async()=>{const e=prompt("New Album:");e&&(await L.getDirectoryHandle(e,{create:!0}),await B())},m.onclick=S,u.oninput=S,p.onchange=S,g.onchange=S,h.onchange=S,w.addEventListener("click",(e=>{if(e.target.matches('.thumb .actions button[title="Metadata"]')){const t=e.target.closest(".thumb");!async function(e,t){const{name:a,handle:n}=e,o=await n.getFile();let i={};o.type.startsWith("image/")&&window.EXIF&&await new Promise((e=>{EXIF.getData(o,(function(){i=EXIF.getAllTags(this),e()}))}));const c={};if(c["File Name"]=a,i.DateTimeOriginal&&(c["Original Date"]=i.DateTimeOriginal),(i.Make||i.Model)&&(c.Camera=[i.Make,i.Model].filter(Boolean).join(" ")),o.type.startsWith("video/")){const e=URL.createObjectURL(o),t=document.createElement("video");t.preload="metadata",t.src=e,await new Promise((e=>{t.onloadedmetadata=()=>{c.Duration=`${t.duration.toFixed(2)} s`,c.Width=t.videoWidth,c.Height=t.videoHeight,e()}}))}c.Size=`${o.size} bytes`,c.Type=o.type,c["Last Modified"]=new Date(o.lastModified).toLocaleString(),renderMetaModal(c,t)}(k.find((e=>e.name===t._filename)),C)}})),b.onclick=()=>C.style.display="none",window.addEventListener("load",(async()=>{const a=await async function(){const t=(await e()).transaction("handles","readonly");return new Promise((e=>{const a=t.objectStore("handles").get("last");a.onsuccess=()=>e(a.result),a.onerror=()=>e(null)}))}();L=a||await window.showDirectoryPicker({startIn:"downloads"}),a||await t(L),I=L,await S(),await B(),x(v)}));
//# sourceMappingURL=widget.js.map
