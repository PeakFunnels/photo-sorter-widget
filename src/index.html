<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

:root {
  --brand-primary: #2B4B4F;
  --brand-accent:  #0658A9;
  --bg:            #f4f6f8;
  --surface:       #ffffff;
  --text-main:     #202124;
  --text-sub:      #5f6368;
  --gap:           16px;
  --radius:        8px;
  --thumb:         220px;
  --shadow-light:  rgba(0,0,0,0.05) 0px 1px 3px;
  --shadow-md:     rgba(0,0,0,0.1) 0px 4px 8px;
}

* { box-sizing: border-box; margin:0; padding:0; }
html, body { height:100%; font-family:'Roboto',sans-serif; background:var(--bg); color:var(--text-main); }

.sorter { display:grid; grid-template-rows:auto auto 1fr; height:100vh; }

header {
  display:flex; align-items:center; gap:var(--gap);
  padding:8px var(--gap); background:var(--surface);
  box-shadow:var(--shadow-light); position:sticky; top:0; z-index:10;
}
header button, header select, header input {
  font-size:.9rem; padding:6px 12px; border-radius:var(--radius);
  border:1px solid #ccc; background:var(--surface); color:var(--text-main);
  transition:all .2s;
}
header button {
  background:var(--brand-accent); color:#fff; border:none; font-weight:500;
}
header button:hover {
  background:#054c8c; box-shadow:var(--shadow-md);
}
header input { flex:1; }

#breadcrumb {
  padding:var(--gap); background:var(--surface);
  font-size:.85rem; color:var(--text-sub); border-bottom:1px solid #eee;
}

main {
  display:grid; grid-template-columns:3fr 1fr;
  gap:var(--gap); padding:0 var(--gap);
  height:calc(100vh - 112px); overflow:hidden;
}

.thumb-grid {
  background:var(--surface); border-radius:var(--radius);
  padding:var(--gap); display:grid;
  grid-template-columns:repeat(3,1fr); grid-auto-rows:var(--thumb);
  gap:var(--gap); overflow-y:auto; box-shadow:var(--shadow-light);
}
.thumb {
  position:relative; background:#ececec; border-radius:var(--radius);
  overflow:hidden; transition:transform .2s, box-shadow .2s;
}
.thumb:hover {
  transform:translateY(-4px); box-shadow:var(--shadow-light);
}
.icon {
  font-size:2rem; color:var(--text-sub);
}
.thumb img {
  position:absolute; top:0; left:0;
  width:100%; height:100%; object-fit:cover;
}
.thumb .name {
  position:absolute; bottom:0; width:100%;
  background:rgba(0,0,0,0.6); color:#fff;
  padding:4px 8px; font-size:.8rem;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.thumb .actions {
  position:absolute; top:8px; right:8px;
  display:flex; gap:4px; opacity:0; transition:opacity .2s;
}
.thumb:hover .actions { opacity:1; }
.actions button {
  background:rgba(255,255,255,0.9); border:none;
  border-radius:4px; padding:4px 6px; font-size:.8rem; cursor:pointer;
}

.sidebar {
  background:var(--surface); border-radius:var(--radius);
  padding:var(--gap); overflow-y:auto; box-shadow:var(--shadow-light);
}
.sidebar h2 {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:var(--gap); font-weight:500;
}
.sidebar h2 button {
  background:none; border:none; font-size:1.2rem; color:var(--brand-accent); cursor:pointer;
}
.nav-item {
  padding:8px 12px; margin:4px 0; border-radius:var(--radius);
  cursor:pointer; font-weight:500; color:var(--brand-primary);
  transition:background .2s;
}
.nav-item:hover, .nav-item.active {
  background:rgba(6,88,169,0.1);
}
.category { margin-bottom:var(--gap); }
.cat-header { display:flex; justify-content:space-between; align-items:center; }
.group {
  padding:8px 12px; margin:4px 0; border-radius:var(--radius);
  cursor:pointer; transition:background .2s;
}
.group:hover, .group.active {
  background:rgba(6,88,169,0.1);
}

/* Metadata modal */
#metaModal {
  position:fixed; top:50%; left:50%;
  transform:translate(-50%,-50%);
  background:var(--surface); border-radius:var(--radius);
  box-shadow:var(--shadow-md); max-width:80%; max-height:70%;
  overflow:auto; padding:24px; display:none; z-index:100;
}
#metaModal h3 {
  margin-top:0; font-weight:500; font-size:1.1rem;
}
#metaModal table {
  width:100%; border-collapse:collapse; margin-top:12px;
}
#metaModal th, #metaModal td {
  text-align:left; padding:6px 8px; border-bottom:1px solid #eee;
}
#metaModal .close {
  position:absolute; top:12px; right:12px;
  background:none; border:none; font-size:1.2rem; cursor:pointer;
}

/* Responsive */
@media(max-width:1024px){
  .thumb-grid { grid-template-columns:repeat(2,1fr); }
}
@media(max-width:600px){
  main { flex-direction:column; display:flex; height:auto; }
  .thumb-grid {
    grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
    max-height:calc(2 * var(--thumb) + var(--gap)); overflow-y:auto;
  }
  .sidebar { width:100%; margin:0 var(--gap) var(--gap); }
  header { flex-wrap:wrap; row-gap:8px; justify-content:space-between; }
  header input, header select { flex:1 1 100%; }
  header button { flex:1 1 calc(50% - 8px); }
  #breadcrumb { padding:8px var(--gap); }
}
@media(max-width:400px){
  .thumb-grid { grid-template-columns:1fr; }
  .thumb { height:140px; }
  header button,input,select { font-size:.8rem; padding:6px 8px; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

<div class="sorter">
  <header>
    <button id="pickBtn">üìÅ Pick Folder</button>
    <button id="refreshBtn" disabled>üîÑ Refresh</button>
    <span id="statusBar"></span>
    <input id="searchInput" type="text" placeholder="Search files‚Ä¶">

    <select id="mediaFilter">
      <option value="all" selected>All Media</option>
      <option value="photos">Photos Only</option>
      <option value="videos">Videos Only</option>
    </select>

    <select id="sortSelect">
      <option value="alpha">A ‚Üí Z</option>
      <option value="date" selected>Last Edited</option>
    </select>

    <label><input type="checkbox" id="includeSub"> Include Subfolders</label>
  </header>

  <div id="breadcrumb">Home</div>

  <main>
    <div id="thumbGrid" class="thumb-grid"></div>
    <aside class="sidebar">
      <div class="nav-item active" data-type="root">üè† All Files</div>
      <h2>Albums <button id="addCat">‚ûï</button></h2>
      <div id="tree"></div>
    </aside>
  </main>
</div>

<div id="metaModal">
  <button class="close">‚úñ</button>
  <h3>Metadata</h3>
  <div id="metaContent"></div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ IndexedDB Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openHandleDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open('file-sorter-db', 1);
    req.onupgradeneeded = () => req.result.createObjectStore('handles');
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}
async function saveLastHandle(handle) {
  const db = await openHandleDB();
  const tx = db.transaction('handles','readwrite');
  tx.objectStore('handles').put(handle,'last');
  return new Promise(r=>tx.oncomplete=r);
}
async function getLastHandle() {
  const db = await openHandleDB();
  const tx = db.transaction('handles','readonly');
  return new Promise(res=>{
    const r = tx.objectStore('handles').get('last');
    r.onsuccess = () => res(r.result);
    r.onerror   = () => res(null);
  });
}

// ‚îÄ‚îÄ‚îÄ Refs & State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const pickBtn     = document.getElementById('pickBtn'),
      refreshBtn  = document.getElementById('refreshBtn'),
      statusBar   = document.getElementById('statusBar'),
      searchInput = document.getElementById('searchInput'),
      sortSelect  = document.getElementById('sortSelect'),
      mediaFilter = document.getElementById('mediaFilter'),
      includeSub  = document.getElementById('includeSub'),
      thumbGrid   = document.getElementById('thumbGrid'),
      tree        = document.getElementById('tree'),
      addAlbum    = document.getElementById('addCat'),
      navRoot     = document.querySelector('.nav-item[data-type="root"]'),
      breadcrumb  = document.getElementById('breadcrumb'),
      metaModal   = document.getElementById('metaModal'),
      metaContent = document.getElementById('metaContent'),
      metaClose   = metaModal.querySelector('.close');

let rootDir, currentHandle = null;
let allFiles = [], displayed = [], loaded = 0;
const batch = 30;
let selected = new Set(), albums = [];

const IMAGE_EXTS = ['.jpg','.jpeg','.png','.gif','.bmp','.webp','.tiff'];
const VIDEO_EXTS = ['.mp4','.mov','.webm'];

// ‚îÄ‚îÄ‚îÄ Layout & Infinite Scroll ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.documentElement.style.setProperty('--thumb','220px');
thumbGrid.addEventListener('scroll', () => {
  if (thumbGrid.scrollTop + thumbGrid.clientHeight >= thumbGrid.scrollHeight - 100
      && loaded < displayed.length) loadMore();
});

// ‚îÄ‚îÄ‚îÄ Lazy-Load Observer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const observer = new IntersectionObserver(entries => {
  for (let e of entries) {
    if (e.isIntersecting && !e.target._loaded) {
      generateThumb(e.target._handle, e.target);
      e.target._loaded = true;
      observer.unobserve(e.target);
    }
  }
}, { root: thumbGrid, rootMargin:'200px' });

// ‚îÄ‚îÄ‚îÄ Navigation & Breadcrumb ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
navRoot.onclick = ()=>{ setActiveNav(navRoot); currentHandle=rootDir; updateBreadcrumb(); loadRootFiles(); };
function setActiveNav(el){
  document.querySelectorAll('.nav-item,.group').forEach(x=>x.classList.remove('active'));
  el.classList.add('active');
}
function updateBreadcrumb(cat, grp){
  breadcrumb.textContent = !cat
    ? 'Home'
    : !grp
      ? `Home / ${cat}`
      : `Home / ${cat} / ${grp}`;
}

// ‚îÄ‚îÄ‚îÄ Directory Walkers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function walkRecursive(dir,arr=[]){
  for await(let [name,handle] of dir){
    if(handle.kind==='file'){
      const f=await handle.getFile();
      arr.push({ name, handle, date: f.lastModified });
    } else {
      await walkRecursive(handle,arr);
    }
  }
  return arr;
}
async function walkRoot(dir,arr=[]){
  for await(let [name,handle] of dir){
    if(handle.kind==='file'){
      const f=await handle.getFile();
      arr.push({ name, handle, date: f.lastModified });
    }
  }
  return arr;
}

// ‚îÄ‚îÄ‚îÄ Initial Load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadRootFiles(){
  allFiles = includeSub.checked
    ? await walkRecursive(rootDir,[])
    : await walkRoot(rootDir,[]);
  resetGrid();
  updateBreadcrumb();
}

// ‚îÄ‚îÄ‚îÄ Media Filtering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterByMedia(list){
  const m=mediaFilter.value;
  if(m==='all') return list;
  return list.filter(f=>{
    const ext=f.name.slice(f.name.lastIndexOf('.')).toLowerCase();
    return m==='photos'
      ? IMAGE_EXTS.includes(ext)
      : VIDEO_EXTS.includes(ext);
  });
}

// ‚îÄ‚îÄ‚îÄ Search, Sort & Refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyFilters(){
  let list=[...allFiles];
  const q=searchInput.value.trim().toLowerCase();
  if(q) list=list.filter(f=>f.name.toLowerCase().includes(q));
  list=filterByMedia(list);
  if(sortSelect.value==='alpha') list.sort((a,b)=>a.name.localeCompare(b.name));
  else list.sort((a,b)=>b.date-a.date);
  return list;
}
function resetGrid(){
  thumbGrid.innerHTML=''; loaded=0;
  displayed=applyFilters();
  loadMore();
  refreshBtn.disabled=false;
}

// ‚îÄ‚îÄ‚îÄ Main Renderer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadMore(){
  const slice=displayed.slice(loaded,loaded+batch);
  for(let f of slice){
    const cell=document.createElement('div'); cell.className='thumb';
    cell._handle=f.handle; cell._filename=f.name;
    // placeholder
    const ph=document.createElement('div'); ph.className='icon'; ph.textContent='‚Ä¶';
    cell.appendChild(ph);

    // actions
    const acts=document.createElement('div'); acts.className='actions';
    const ext=f.name.slice(f.name.lastIndexOf('.')).toLowerCase();

    // rename
    const rb=document.createElement('button'); rb.textContent='‚úé'; rb.title='Rename';
    rb.onclick=async e=>{
      e.stopPropagation();
      const base=prompt('Rename to:',f.name.replace(ext,''));
      if(!base)return;
      const nm=base.endsWith(ext)?base:base+ext;
      const blob=await f.handle.getFile();
      const nh=await currentHandle.getFileHandle(nm,{create:true});
      const w=await nh.createWritable(); await w.write(blob); await w.close();
      await currentHandle.removeEntry(f.name);
      await loadRootFiles();
    };
    acts.appendChild(rb);

    // delete
    const dbBtn=document.createElement('button'); dbBtn.textContent='üóë'; dbBtn.title='Delete';
    dbBtn.onclick=async e=>{
      e.stopPropagation();
      if(!confirm(`Delete ${f.name}?`)) return;
      await currentHandle.removeEntry(f.name);
      await loadRootFiles();
    };
    acts.appendChild(dbBtn);

    // info
    const ib=document.createElement('button'); ib.textContent='‚ÑπÔ∏è'; ib.title='Metadata';
    ib.onclick=e=>{ e.stopPropagation(); showMetadata(f); };
    acts.appendChild(ib);

    // open
    const ob=document.createElement('button');
    ob.textContent=VIDEO_EXTS.includes(ext)?'‚ñ∂Ô∏è':'üîç';
    ob.title='Open'; ob.onclick=async e=>{
      e.stopPropagation();
      const file=await f.handle.getFile();
      const url=URL.createObjectURL(file);
      window.open(url,'_blank');
    };
    acts.appendChild(ob);

    cell.appendChild(acts);

    // label
    const lbl=document.createElement('div'); lbl.className='name'; lbl.textContent=f.name;
    cell.appendChild(lbl);

    // selection
    cell.onclick=ev=>{
      ev.preventDefault();
      if(ev.ctrlKey||ev.metaKey){
        if(selected.has(f)){ selected.delete(f); cell.classList.remove('selected'); }
        else{ selected.add(f); cell.classList.add('selected'); }
      } else {
        thumbGrid.querySelectorAll('.thumb.selected').forEach(x=>x.classList.remove('selected'));
        selected.clear(); selected.add(f); cell.classList.add('selected');
      }
    };

    // drag
    cell.draggable=true;
    cell.ondragstart=e=>{
      const names=selected.has(f)
        ? Array.from(selected).map(x=>x.name)
        : [f.name];
      e.dataTransfer.setData('application/json',JSON.stringify(names));
    };

    thumbGrid.appendChild(cell);
    observer.observe(cell);
  }
  loaded+=slice.length;
}

// ‚îÄ‚îÄ‚îÄ Thumbnail Generator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateThumb(handle, cell){
  handle.getFile().then(file=>{
    const size = parseInt(getComputedStyle(cell).getPropertyValue('--thumb'));
    const url  = URL.createObjectURL(file);
    const probe = document.createElement('video');
    const canPlay = probe.canPlayType(file.type)!=='';

    if(file.type.startsWith('video/')&&canPlay){
      probe.preload='metadata'; probe.muted=true; probe.src=url; probe.currentTime=0.5;
      probe.onseeked=async()=>{
        const bm=await createImageBitmap(probe,{resizeWidth:size,resizeHeight:size,resizeQuality:'high'});
        const cnv=document.createElement('canvas');cnv.width=cnv.height=size;
        cnv.getContext('2d').drawImage(bm,0,0);
        const img=document.createElement('img'); img.src=cnv.toDataURL('image/jpeg',0.75);
        cell.replaceChild(img,cell.querySelector('.icon'));
      };
    } else if(file.type.startsWith('image/')){
      const img=new Image(); img.src=url;
      img.onload=async()=>{
        const bm=await createImageBitmap(img,{resizeWidth:size,resizeHeight:size,resizeQuality:'high'});
        const cnv=document.createElement('canvas');cnv.width=cnv.height=size;
        cnv.getContext('2d').drawImage(bm,0,0);
        const thumb=document.createElement('img'); thumb.src=cnv.toDataURL('image/jpeg',0.75);
        cell.replaceChild(thumb,cell.querySelector('.icon'));
      };
    } else if(file.type.startsWith('video/')){
      const icon=document.createElement('div'); icon.className='icon'; icon.textContent='üé•';
      cell.replaceChild(icon,cell.querySelector('.icon'));
    } else {
      const icon=document.createElement('div'); icon.className='icon'; icon.textContent='üìÑ';
      cell.replaceChild(icon,cell.querySelector('.icon'));
    }
  });
}

// ‚îÄ‚îÄ‚îÄ Albums Sidebar & Drop Move ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAlbums(){
  albums=[];
  for await(let [name,h] of rootDir){
    if(h.kind==='directory'){
      const gr=[]; for await(let [gn,gh] of h) if(gh.kind==='directory')gr.push(gn);
      albums.push({ name, handle:h, groups:gr });
    }
  }
  renderAlbums();
}
function renderAlbums(){
  tree.innerHTML='';
  albums.forEach((a,i)=>{
    const cd=document.createElement('div');cd.className='category';
    const hdr=document.createElement('div');hdr.className='cat-header';hdr.textContent=a.name;
    const btn=document.createElement('button');btn.textContent='‚ûï';
    btn.onclick=async()=>{
      const nm=prompt('New Group:'); if(!nm) return;
      await a.handle.getDirectoryHandle(nm,{create:true});
      await loadAlbums();
    };
    hdr.appendChild(btn); cd.appendChild(hdr);

    a.groups.forEach(g=>{
      const gd=document.createElement('div');gd.className='group';gd.textContent=g;
      // navigate
      gd.onclick=async()=>{
        setActiveNav(gd);
        currentHandle=await a.handle.getDirectoryHandle(g);
        updateBreadcrumb(a.name,g);
        allFiles=await walkRecursive(currentHandle,[]);
        resetGrid();
      };
      // drop move
      gd.addEventListener('dragover',e=>{ e.preventDefault(); gd.classList.add('dragover'); });
      gd.addEventListener('dragleave',()=>gd.classList.remove('dragover'));
      gd.addEventListener('drop',async e=>{
        e.preventDefault(); gd.classList.remove('dragover');
        const names=JSON.parse(e.dataTransfer.getData('application/json'));
        let moved=0, failed=0;
        for(let nm of names){
          try{
            const f=allFiles.find(x=>x.name===nm);
            const blob=await f.handle.getFile();
            const targetDir = await a.handle.getDirectoryHandle(g,{create:true});
            const dest = await targetDir.getFileHandle(nm,{create:true});
            const w = await dest.createWritable(); await w.write(blob); await w.close();
            await currentHandle.removeEntry(nm);
            moved++;
          } catch {
            failed++;
          }
        }
        alert(`Moved ${moved} file${moved!==1?'s':''}${failed ? `, ${failed} failed` : ''}.`);
        if(currentHandle===rootDir) await loadRootFiles();
        else { allFiles=await walkRecursive(currentHandle,[]); resetGrid(); }
      });
      cd.appendChild(gd);
    });

    tree.appendChild(cd);
  });
}

// ‚îÄ‚îÄ‚îÄ Metadata Display ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function showMetadata(fe){
  const file=await fe.handle.getFile();
  let data={};

  if(file.type.startsWith('image/')&&window.EXIF){
    await new Promise(res=>EXIF.getData(file,function(){ data=EXIF.getAllTags(this); res(); }));
  } else if(file.type.startsWith('video/')){
    data['File name'] = file.name;
    data['Size'] = `${file.size} bytes`;
    data['Type'] = file.type;
    data['Last modified'] = new Date(file.lastModified).toLocaleString();
    const url=URL.createObjectURL(file);
    const vid=document.createElement('video'); vid.preload='metadata'; vid.src=url;
    vid.onloadedmetadata=()=>{
      data['Duration'] = `${vid.duration.toFixed(2)} s`;
      data['Width'] = vid.videoWidth;
      data['Height'] = vid.videoHeight;
      renderMetaModal(data);
    };
    return;
  }

  data['File name'] = file.name;
  data['Size'] = `${file.size} bytes`;
  data['Type'] = file.type;
  data['Last modified'] = new Date(file.lastModified).toLocaleString();
  renderMetaModal(data);
}
function renderMetaModal(data){
  metaContent.innerHTML='';
  const tbl=document.createElement('table');
  for(let [k,v] of Object.entries(data)){
    const tr=document.createElement('tr');
    const th=document.createElement('th'); th.textContent=k;
    const td=document.createElement('td'); td.textContent=v;
    tr.appendChild(th); tr.appendChild(td); tbl.appendChild(tr);
  }
  metaContent.appendChild(tbl);
  metaModal.style.display='block';
}
metaClose.onclick = ()=> metaModal.style.display='none';

// ‚îÄ‚îÄ‚îÄ Initialization & Bindings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load',async()=>{
  const last = await getLastHandle();
  if(last) rootDir = last;
  else {
    rootDir = await window.showDirectoryPicker({startIn:'downloads'});
    await saveLastHandle(rootDir);
  }
  currentHandle = rootDir;
  await loadRootFiles();
  await loadAlbums();
  setActiveNav(navRoot);
});

pickBtn.onclick = async()=>{
  rootDir = await window.showDirectoryPicker();
  await saveLastHandle(rootDir);
  currentHandle = rootDir;
  await loadRootFiles();
  await loadAlbums();
  setActiveNav(navRoot);
};
refreshBtn.onclick = resetGrid;
addAlbum.onclick = async()=>{
  const nm = prompt('New Album:'); if(!nm) return;
  await rootDir.getDirectoryHandle(nm,{create:true});
  await loadAlbums();
};
searchInput.oninput = resetGrid;
sortSelect.onchange  = resetGrid;
mediaFilter.onchange  = resetGrid;
includeSub.onchange   = ()=>{ if(currentHandle===rootDir) loadRootFiles(); };
</script>